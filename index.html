<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Ingressos - QR Code</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        #reader {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 3px solid #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result.success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .result.warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }

        .result h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .result p {
            margin: 5px 0;
            font-size: 14px;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
            color: #667eea;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #camera-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        #manual-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé´ Validador de Ingressos</h1>
            <p>Sistema de Check-in por QR Code</p>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>‚öôÔ∏è Configura√ß√£o Necess√°ria:</strong>
                <p>1. Cole a URL do seu webhook N8N abaixo</p>
                <p>2. O webhook deve receber o campo "codigo"</p>
                <p>3. E retornar: { "success": true/false, "message": "...", "data": {...} }</p>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="webhook-url" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">
                    URL do Webhook N8N:
                </label>
                <input 
                    type="text" 
                    id="webhook-url" 
                    placeholder="https://seu-n8n.com/webhook/validar-ingresso"
                    style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;"
                    value=""
                >
            </div>

            <button id="start-btn" class="btn btn-primary" onclick="startScanner()">
                üì∑ Iniciar Scanner
            </button>

            <button class="btn btn-secondary" onclick="toggleManualInput()" style="margin-top: 5px;">
                ‚úçÔ∏è Usar Entrada Manual
            </button>

            <div id="camera-status" class="hidden"></div>

            <div id="reader" class="hidden"></div>

            <button id="stop-btn" class="btn btn-danger hidden" onclick="stopScanner()">
                ‚èπÔ∏è Parar Scanner
            </button>

            <div id="manual-input-section" class="hidden" style="margin-top: 20px;">
                <div class="info-box" style="border-left-color: #ffc107;">
                    <strong>‚úçÔ∏è Entrada Manual</strong>
                    <p>Se a c√¢mera n√£o funcionar, digite o c√≥digo do ingresso manualmente:</p>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input 
                        type="text" 
                        id="manual-code" 
                        placeholder="Ex: NEEL1761875445591-A"
                        style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; text-transform: uppercase;"
                    >
                    <button class="btn btn-primary" onclick="validateManualCode()" style="width: auto; padding: 12px 24px;">
                        Validar
                    </button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 10px;">Validando ingresso...</p>
            </div>

            <div id="result" class="result"></div>
        </div>
    </div>

    <script>
        let html5QrCode;
        let isScanning = false;
        let cameras = [];

        // Fun√ß√£o para extrair o c√≥digo do ingresso do texto do QR Code
        function extractCodigoFromQRText(qrText) {
            // Procura pela linha "CODIGO: XXXXXXX"
            const codigoMatch = qrText.match(/CODIGO:\s*([^\s\n]+)/);
            if (codigoMatch && codigoMatch[1]) {
                return codigoMatch[1];
            }
            
            // Alternativa: procura por "INGRESSO: XXXXXXX"
            const ingressoMatch = qrText.match(/INGRESSO:\s*([^\s\n]+)/);
            if (ingressoMatch && ingressoMatch[1]) {
                return ingressoMatch[1];
            }
            
            return null;
        }

        // Fun√ß√£o para detectar c√¢meras dispon√≠veis
        async function detectCameras() {
            try {
                const devices = await Html5Qrcode.getCameras();
                cameras = devices;
                
                if (devices && devices.length > 0) {
                    console.log(`${devices.length} c√¢mera(s) detectada(s)`);
                    return true;
                }
                return false;
            } catch (err) {
                console.error('Erro ao detectar c√¢meras:', err);
                return false;
            }
        }

        // Fun√ß√£o melhorada para iniciar o scanner (compat√≠vel com Android)
        async function startScanner() {
            const webhookUrl = document.getElementById('webhook-url').value.trim();
            
            if (!webhookUrl) {
                showResult('error', 'Erro de Configura√ß√£o', 'Por favor, insira a URL do webhook N8N antes de iniciar o scanner.');
                return;
            }

            if (isScanning) return;

            const cameraStatus = document.getElementById('camera-status');
            cameraStatus.textContent = 'üîç Procurando c√¢meras...';
            cameraStatus.style.background = '#fff3cd';
            cameraStatus.style.color = '#856404';
            cameraStatus.classList.remove('hidden');

            // Detecta c√¢meras dispon√≠veis
            const hasCameras = await detectCameras();
            
            if (!hasCameras) {
                cameraStatus.textContent = '‚ùå Nenhuma c√¢mera encontrada';
                cameraStatus.style.background = '#f8d7da';
                cameraStatus.style.color = '#721c24';
                showResult('error', 'C√¢mera N√£o Encontrada', 
                    'N√£o foi poss√≠vel encontrar uma c√¢mera neste dispositivo. Use o modo de entrada manual abaixo.');
                document.getElementById('manual-input-section').classList.remove('hidden');
                return;
            }

            try {
                cameraStatus.textContent = 'üì∑ Inicializando c√¢mera...';
                
                document.getElementById('reader').classList.remove('hidden');
                document.getElementById('start-btn').classList.add('hidden');
                document.getElementById('stop-btn').classList.remove('hidden');

                html5QrCode = new Html5Qrcode("reader");

                // Configura√ß√£o otimizada para Android
                const config = { 
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                    disableFlip: false,
                    // Configura√ß√µes adicionais para Android
                    experimentalFeatures: {
                        useBarCodeDetectorIfSupported: true
                    }
                };

                // Tenta primeiro com a c√¢mera traseira (environment)
                try {
                    await html5QrCode.start(
                        { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        onScanError
                    );
                } catch (err1) {
                    console.log('Tentativa 1 falhou, tentando com ID da c√¢mera...');
                    
                    // Se falhar, tenta com o ID da √∫ltima c√¢mera (geralmente a traseira)
                    const lastCamera = cameras[cameras.length - 1];
                    try {
                        await html5QrCode.start(
                            lastCamera.id,
                            config,
                            onScanSuccess,
                            onScanError
                        );
                    } catch (err2) {
                        console.log('Tentativa 2 falhou, tentando com primeira c√¢mera...');
                        
                        // Se ainda falhar, tenta com a primeira c√¢mera
                        await html5QrCode.start(
                            cameras[0].id,
                            config,
                            onScanSuccess,
                            onScanError
                        );
                    }
                }

                isScanning = true;
                cameraStatus.textContent = '‚úÖ C√¢mera ativa - Aponte para o QR Code';
                cameraStatus.style.background = '#d4edda';
                cameraStatus.style.color = '#155724';

            } catch (err) {
                console.error('Erro ao iniciar scanner:', err);
                
                let errorMessage = 'N√£o foi poss√≠vel acessar a c√¢mera. ';
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage += 'Por favor, permita o acesso √† c√¢mera nas configura√ß√µes do navegador.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage += 'C√¢mera n√£o encontrada neste dispositivo.';
                } else if (err.name === 'NotReadableError') {
                    errorMessage += 'A c√¢mera est√° sendo usada por outro aplicativo. Feche outros apps e tente novamente.';
                } else {
                    errorMessage += 'Erro: ' + err.message;
                }
                
                cameraStatus.textContent = '‚ùå Erro ao acessar c√¢mera';
                cameraStatus.style.background = '#f8d7da';
                cameraStatus.style.color = '#721c24';
                
                showResult('error', 'Erro na C√¢mera', errorMessage + '<br><br>üí° <strong>Tente:</strong><br>1. Recarregar a p√°gina<br>2. Permitir acesso √† c√¢mera<br>3. Fechar outros apps usando a c√¢mera<br>4. Usar o modo de entrada manual abaixo');
                
                // Mostra op√ß√£o de entrada manual
                document.getElementById('manual-input-section').classList.remove('hidden');
                
                resetScanner();
            }
        }

        // Fun√ß√£o para parar o scanner
        async function stopScanner() {
            if (html5QrCode && isScanning) {
                try {
                    await html5QrCode.stop();
                    resetScanner();
                } catch (err) {
                    console.error('Erro ao parar scanner:', err);
                }
            }
        }

        // Fun√ß√£o para resetar o scanner
        function resetScanner() {
            isScanning = false;
            document.getElementById('reader').classList.add('hidden');
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('camera-status').classList.add('hidden');
        }

        // Callback quando QR Code √© lido com sucesso
        async function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code lido:', decodedText);

            // Pausa o scanner temporariamente
            if (html5QrCode && isScanning) {
                await html5QrCode.pause();
            }

            // Extrai o c√≥digo do ingresso
            const codigo = extractCodigoFromQRText(decodedText);

            if (!codigo) {
                showResult('warning', 'QR Code Inv√°lido', 'N√£o foi poss√≠vel extrair o c√≥digo do ingresso deste QR Code.');
                setTimeout(() => {
                    if (html5QrCode && isScanning) {
                        html5QrCode.resume();
                    }
                }, 3000);
                return;
            }

            // Valida com o webhook
            await validateTicket(codigo, decodedText);
        }

        // Callback para erros de leitura (pode ser ignorado)
        function onScanError(errorMessage) {
            // Ignora erros comuns de scan
        }

        // Fun√ß√£o para validar o ingresso via webhook
        async function validateTicket(codigo, qrData) {
            const webhookUrl = document.getElementById('webhook-url').value.trim();
            const loading = document.getElementById('loading');
            
            loading.classList.add('active');

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        qr_data: qrData,
                        timestamp: new Date().toISOString()
                    })
                });

                const result = await response.json();

                loading.classList.remove('active');

                if (result.success) {
                    // Extrai informa√ß√µes do participante
                    const nomeMatch = qrData.match(/PARTICIPANTE:\s*([^\n]+)/);
                    const nome = nomeMatch ? nomeMatch[1] : 'N/A';

                    showResult('success', '‚úÖ Ingresso Validado!', 
                        `<strong>C√≥digo:</strong> ${codigo}<br>
                         <strong>Participante:</strong> ${nome}<br>
                         <strong>Hora:</strong> ${new Date().toLocaleTimeString('pt-BR')}<br>
                         ${result.message || 'Check-in realizado com sucesso!'}`
                    );

                    // Aguarda 3 segundos e retoma o scanner
                    setTimeout(() => {
                        document.getElementById('result').style.display = 'none';
                        if (html5QrCode && isScanning) {
                            html5QrCode.resume();
                        }
                    }, 3000);

                } else {
                    showResult('error', '‚ùå Ingresso Inv√°lido', 
                        `<strong>C√≥digo:</strong> ${codigo}<br>
                         <strong>Motivo:</strong> ${result.message || 'Ingresso n√£o encontrado ou j√° utilizado'}`
                    );

                    // Aguarda 3 segundos e retoma o scanner
                    setTimeout(() => {
                        document.getElementById('result').style.display = 'none';
                        if (html5QrCode && isScanning) {
                            html5QrCode.resume();
                        }
                    }, 3000);
                }

            } catch (error) {
                console.error('Erro na valida√ß√£o:', error);
                loading.classList.remove('active');
                
                showResult('error', 'Erro de Conex√£o', 
                    'N√£o foi poss√≠vel conectar ao servidor. Verifique a URL do webhook e sua conex√£o com a internet.'
                );

                // Aguarda 3 segundos e retoma o scanner
                setTimeout(() => {
                    document.getElementById('result').style.display = 'none';
                    if (html5QrCode && isScanning) {
                        html5QrCode.resume();
                    }
                }, 3000);
            }
        }

        // Fun√ß√£o para mostrar resultado
        function showResult(type, title, message) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
            `;
            resultDiv.style.display = 'block';
        }

        // Fun√ß√£o para alternar entrada manual
        function toggleManualInput() {
            const manualSection = document.getElementById('manual-input-section');
            manualSection.classList.toggle('hidden');
            
            if (!manualSection.classList.contains('hidden')) {
                // Foca no campo de entrada
                document.getElementById('manual-code').focus();
            }
        }

        // Fun√ß√£o para validar c√≥digo digitado manualmente
        async function validateManualCode() {
            const codigo = document.getElementById('manual-code').value.trim().toUpperCase();
            
            if (!codigo) {
                showResult('warning', 'C√≥digo Vazio', 'Por favor, digite o c√≥digo do ingresso.');
                return;
            }

            // Simula o texto do QR code para manter compatibilidade
            const qrData = `CODIGO: ${codigo}`;
            
            await validateTicket(codigo, qrData);
            
            // Limpa o campo ap√≥s valida√ß√£o
            document.getElementById('manual-code').value = '';
        }

        // Permite validar com Enter no campo manual
        document.addEventListener('DOMContentLoaded', function() {
            const manualCodeInput = document.getElementById('manual-code');
            if (manualCodeInput) {
                manualCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        validateManualCode();
                    }
                });
            }
        });

        // Salva a URL do webhook no localStorage
        document.getElementById('webhook-url').addEventListener('blur', function() {
            localStorage.setItem('webhook-url', this.value);
        });

        // Carrega a URL do webhook do localStorage
        window.addEventListener('load', function() {
            const savedUrl = localStorage.getItem('webhook-url');
            if (savedUrl) {
                document.getElementById('webhook-url').value = savedUrl;
            }
        });
    </script>
</body>
</html>
